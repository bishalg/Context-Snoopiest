---
import DocLayout from '../layouts/DocLayout.astro';
---

<DocLayout title="Orchestrator Architecture" description="The Supervisor Pattern: Implementing Circular Dependencies for Narrative Consistency.">
    
    <div class="prose prose-lg dark:prose-invert max-w-none text-slate-700 dark:text-slate-300">
        <h1>Orchestrator Architecture</h1>
        
        <p class="lead text-xl text-slate-600 dark:text-slate-400 mb-8">
            If "TOON" is the language your app speaks, the Orchestrator is the Director who speaks it. We replace linear pipelines with a "Loop of Reasoning" that mimics a human film director checking their work.
        </p>

        <h2>The Core Concept: The "Showrunner" Loop</h2>
        <p>
            In a standard LLM script, you fire a prompt and hope for the best. In an Orchestrator (ReAct) model, we build a <strong>Circular Dependency</strong>. The Orchestrator (Showrunner) refuses to generate a video frame until the "Context State" is verified.
        </p>

        <div class="not-prose my-12 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-8 shadow-sm">
            <h3 class="font-bold text-slate-900 dark:text-white mb-6 text-center">The ReAct Pattern for Video Consistency</h3>
            
            <div class="space-y-6 max-w-2xl mx-auto">
                <!-- Step 1: Reason -->
                <div class="flex gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center shrink-0 text-blue-600 dark:text-blue-400 font-bold border border-blue-200 dark:border-blue-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-1">Reason (Thought)</div>
                        <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-700 text-sm italic text-slate-600 dark:text-slate-300">
                            "I need to generate the scene where Arjun enters the cave. Wait, what is he wearing?"
                        </div>
                    </div>
                </div>

                <!-- Step 2: Act -->
                <div class="flex gap-4">
                    <div class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center shrink-0 text-purple-600 dark:text-purple-400 font-bold border border-purple-200 dark:border-purple-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider mb-1">Act (Tool Call)</div>
                        <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-700 font-mono text-xs text-purple-600 dark:text-purple-300">
                            query_toon_state(entity="Arjun", attribute="clothing")
                        </div>
                    </div>
                </div>

                <!-- Step 3: Observe -->
                <div class="flex gap-4">
                    <div class="w-12 h-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center shrink-0 text-emerald-600 dark:text-emerald-400 font-bold border border-emerald-200 dark:border-emerald-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-1">Observe (Result)</div>
                        <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-300">
                            "Result: [Battle-worn Armor, Left Shoulder Pauldron Missing]"
                        </div>
                    </div>
                </div>

                <!-- Step 4: Reason (Correction) -->
                <div class="flex gap-4">
                    <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center shrink-0 text-amber-600 dark:text-amber-400 font-bold border border-amber-200 dark:border-amber-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider mb-1">Reason (Correction)</div>
                        <div class="bg-gray-50 dark:bg-slate-800 p-3 rounded-lg border border-gray-200 dark:border-slate-700 text-sm italic text-slate-600 dark:text-slate-300">
                            "Okay, I must ensure the prompt explicitly mentions the missing pauldron."
                        </div>
                    </div>
                </div>

                <!-- Step 5: Execute -->
                <div class="flex gap-4">
                    <div class="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center shrink-0 text-slate-600 dark:text-slate-400 font-bold border border-slate-200 dark:border-slate-700">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-1">Act (Generation)</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400 mt-2">
                             Sends corrected prompt to Video AI.
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <h2>The Architecture: "The Supervisor Pattern"</h2>
        <p>
            We implement a Multi-Agent Orchestrator. You don't just have "One Bot"; you have a virtual film crew managed by a Supervisor.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-8 not-prose">
            <div class="bg-gray-50 dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700">
                <div class="text-3xl mb-4">‚úçÔ∏è</div>
                <h3 class="font-bold text-slate-900 dark:text-white mb-2">Narrative Extractor</h3>
                <p class="text-xs text-slate-500 font-bold uppercase mb-4">The Scriptwriter</p>
                <div class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <p><span class="font-semibold">Role:</span> Reads the novel chunk.</p>
                    <p><span class="font-semibold">Tool:</span> Text_Compressor.</p>
                    <p><span class="font-semibold">Output:</span> Raw Scene Description.</p>
                </div>
            </div>

            <div class="bg-cyan-50 dark:bg-cyan-900/10 p-6 rounded-xl border border-cyan-200 dark:border-cyan-800">
                <div class="text-3xl mb-4">üõ°Ô∏è</div>
                <h3 class="font-bold text-slate-900 dark:text-white mb-2">Continuity Guard</h3>
                <p class="text-xs text-cyan-600 dark:text-cyan-400 font-bold uppercase mb-4">The Script Supervisor</p>
                <div class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <p><span class="font-semibold">Role:</span> Checks TOON database.</p>
                    <p><span class="font-semibold">Tool:</span> TOON_Retriever.</p>
                    <p><span class="font-semibold">Output:</span> "Correction: Night time, Arjun bleeding."</p>
                </div>
            </div>

            <div class="bg-gray-50 dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700">
                <div class="text-3xl mb-4">üé•</div>
                <h3 class="font-bold text-slate-900 dark:text-white mb-2">Prompt Engineer</h3>
                <p class="text-xs text-slate-500 font-bold uppercase mb-4">The Cinematographer</p>
                <div class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
                    <p><span class="font-semibold">Role:</span> Merges Script + Consistency Check.</p>
                    <p><span class="font-semibold">Tool:</span> Video_Prompt_Generator.</p>
                    <p><span class="font-semibold">Output:</span> Final Stable Diffusion Prompt.</p>
                </div>
            </div>
        </div>

        <h2>Logic Flow: The State Graph</h2>
        <p>
            The Orchestrator code binds them together. It runs a loop that blocks generation until consistency is met.
        </p>

        <!-- Logic Flow Visualization -->
        <div class="not-prose my-12 overflow-hidden bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl relative">
            <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
            
            <div class="p-8 relative z-10 flex flex-col items-center">
                
                <!-- Node 1 -->
                <div class="border-2 border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 rounded px-6 py-3 font-bold text-slate-700 dark:text-slate-300 shadow-sm mb-8">
                    Orchestrator Start
                </div>

                <!-- Down Arrow -->
                <div class="w-0.5 h-8 bg-slate-300 dark:bg-slate-600 mb-2"></div>
                <div class="w-2 h-2 border-b-2 border-r-2 border-slate-300 dark:border-slate-600 transform rotate-45 mb-8"></div>

                <!-- Node 2 -->
                <div class="border-2 border-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded px-6 py-3 font-bold text-blue-800 dark:text-blue-300 shadow-sm mb-8">
                    Agent 1: Extract Scene
                </div>

                <!-- Loop Section -->
                <div class="relative w-full max-w-lg p-8 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl bg-slate-50/50 dark:bg-slate-800/30">
                    <div class="absolute -top-3 left-8 bg-white dark:bg-slate-900 px-2 text-xs font-bold text-slate-400 uppercase tracking-widest">
                        Orchestrator Check Loop
                    </div>

                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 rotate-45 border-2 border-teal-500 bg-teal-500 text-white flex items-center justify-center shadow-lg z-10 mb-8">
                            <span class="-rotate-45 font-bold text-xs">?</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-12 w-full">
                             <!-- Left Branch -->
                             <div class="flex flex-col items-center">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-2">"Who is here?"</div>
                                <div class="border-2 border-teal-500 bg-white dark:bg-slate-800 rounded px-4 py-2 text-sm text-center shadow-sm">
                                    <strong>Agent 2</strong><br/>Query TOON State
                                </div>
                                <div class="h-4 w-0.5 bg-teal-500 mt-2"></div>
                                <div class="text-[10px] text-teal-600 dark:text-teal-400 font-bold bg-teal-50 dark:bg-teal-900/30 px-2 py-0.5 rounded-full mt-1">Returns Visuals</div>
                             </div>

                             <!-- Right Branch -->
                             <div class="flex flex-col items-center opacity-50">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-2">Rejected?</div>
                                <div class="border-2 border-red-400 bg-white dark:bg-slate-800 rounded px-4 py-2 text-sm text-center shadow-sm">
                                    <strong>Reviewer Agent</strong>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- Down Arrow -->
                <div class="w-0.5 h-8 bg-slate-300 dark:bg-slate-600 mt-8 mb-2"></div>
                <div class="w-2 h-2 border-b-2 border-r-2 border-slate-300 dark:border-slate-600 transform rotate-45 mb-8"></div>

                <!-- Final Nodes -->
                <div class="flex gap-4">
                    <div class="border-2 border-purple-500 bg-purple-50 dark:bg-purple-900/20 rounded px-6 py-3 font-bold text-purple-800 dark:text-purple-300 shadow-sm">
                        Agent 3: Generate Video
                    </div>
                </div>

            </div>
        </div>

        <h2>Implementation Details</h2>
        
        <h3>The Orchestrator State</h3>
        <p>Using TypeScript interfaces to define the "Showrunner's Clipboard".</p>
        
        <div class="not-prose bg-main rounded-lg overflow-hidden border border-black/5 dark:border-white/10 mb-8">
            <div class="flex items-center gap-2 px-4 py-2 bg-black/5 dark:bg-white/5 border-b border-black/5 dark:border-white/5">
                <div class="w-3 h-3 rounded-full bg-red-400/80"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-400/80"></div>
                <div class="w-3 h-3 rounded-full bg-green-400/80"></div>
                <span class="text-xs text-slate-500 ml-2 font-mono">orchestrator.ts</span>
            </div>
            <pre class="p-4 overflow-x-auto text-sm"><code class="language-typescript text-slate-700 dark:text-slate-300"><span class="text-purple-600 dark:text-purple-400">interface</span> <span class="text-yellow-600 dark:text-yellow-400">ShowrunnerState</span> &#123;
  current_chunk: <span class="text-blue-600 dark:text-blue-400">string</span>;
  toon_history: <span class="text-blue-600 dark:text-blue-400">string</span>; <span class="text-slate-400">// The compressed context</span>
  visual_plan: <span class="text-blue-600 dark:text-blue-400">string</span> | <span class="text-blue-600 dark:text-blue-400">null</span>;
  video_url: <span class="text-blue-600 dark:text-blue-400">string</span> | <span class="text-blue-600 dark:text-blue-400">null</span>;
  retry_count: <span class="text-blue-600 dark:text-blue-400">number</span>;
&#125;</code></pre>
        </div>

        <h3>Why This Solves "Hallucination"</h3>
        <p>
            In standard LLM apps, the model forgets that a character lost their sword three scenes ago.
        </p>
        <ul className="list-disc pl-6 space-y-2 mb-8">
            <li><strong>Without Orchestrator:</strong> The model guesses.</li>
            <li><strong>With Orchestrator:</strong> The "Continuity Guard" agent forces the "Cinematographer" agent to include "No Sword" in the negative prompt or description before the request is ever sent to the Video AI.</li>
        </ul>

    </div>
</DocLayout>
