---
// Token Weight Chart Component
---

<div
  class="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-lg border border-slate-200 dark:border-white/5 my-8 not-prose"
>
  <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">
    Weighted Token Analysis
  </h3>
  <p class="text-xs text-slate-500 dark:text-slate-400 mb-6">
    Visualizing the time-cost multiplier for different content types.
  </p>

  <div class="chart-container relative h-[250px] w-full">
    <canvas id="weightChart"></canvas>
  </div>
</div>

<script>
  import Chart from "chart.js/auto";

  const initChart = () => {
    const ctx = document.getElementById("weightChart") as HTMLCanvasElement;
    if (ctx && ctx.parentElement) {
      // Intersection Observer to trigger animation when in view
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              createChart(ctx);
              observer.disconnect();
            }
          });
        },
        { threshold: 0.2 },
      );

      observer.observe(ctx.parentElement);
    }
  };

  const createChart = (ctx: HTMLCanvasElement) => {
    // Destroy existing chart instance if it exists
    const existingChart = Chart.getChart(ctx);
    if (existingChart) {
      existingChart.destroy();
    }

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Dialogue", "Description", "Action (Fast)", "Action (Slow)"],
        datasets: [
          {
            label: "Time-Cost Multiplier",
            data: [1.0, 0.7, 0.5, 2.0],
            backgroundColor: [
              "#6366F1", // Indigo (Dialogue)
              "#0EA5E9", // Sky (Desc)
              "#EF4444", // Red (Fast Action)
              "#F59E0B", // Amber (Slow Action)
            ],
            borderRadius: 8,
            borderSkipped: false,
            // @ts-ignore
            hoverBorderWidth: 2,
            hoverBorderColor: "#fff",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        onHover: (event, chartElement) => {
          if (event.native && event.native.target) {
            (event.native.target as HTMLElement).style.cursor =
              chartElement.length ? "pointer" : "default";
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "rgba(15, 23, 42, 0.95)",
            padding: 16,
            cornerRadius: 12,
            titleFont: { size: 14, weight: "bold" },
            bodyFont: { size: 13 },
            callbacks: {
              label: function (context) {
                const value = context.raw as number;
                let example = "";
                if (context.label === "Dialogue")
                  example = '"Hello there!" (Natural)';
                if (context.label === "Description")
                  example = "The room was dark. (Fast process)";
                if (context.label === "Action (Fast)")
                  example = "He ran. (Rapid cuts)";
                if (context.label === "Action (Slow)")
                  example = "The sun set. (Time-lapse)";

                return [`Multiplier: ${value}x`, example];
              },
            },
          },
        },
        animation: {
          duration: 2000,
          easing: "easeOutElastic",
          delay: (context) => {
            let delay = 0;
            if (context.type === "data" && context.mode === "default") {
              delay = context.dataIndex * 400; // Staggered delay
            }
            return delay;
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: "Time Weight (1.0 = Realtime)" },
            grid: { color: "rgba(148, 163, 184, 0.1)" },
          },
          x: {
            grid: { display: false },
          },
        },
        hover: {
          mode: "nearest",
          intersect: true,
        },
      },
    });
  };

  // Run on both DOMContentLoaded and astro:page-load
  document.addEventListener("DOMContentLoaded", initChart);
  document.addEventListener("astro:page-load", initChart);
</script>
